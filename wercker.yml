box: miaoxing/build:v0.9.1

services:
  - id: mysql:5.6
    env:
      MYSQL_ROOT_PASSWORD: mypassword

build:
  steps:
    - script:
        name: wait for mysql connection
        code: |
          while ! nc -q 1 $MYSQL_PORT_3306_TCP_ADDR $MYSQL_PORT_3306_TCP_PORT < /dev/null; do sleep 2; done
    - mbrevda/composer-install@1.0.1
    - script:
        name: PHPUnit integration tests
        code: phpunit --verbose --stderr --coverage-text |& tee -a coverage.txt
    - script:
        name: check coverage
        code: php vendor/miaoxing/plugin/build/check-coverage.php 95
    - script:
        name: perform project mess detection using PHPMD
        code: phpmd . text vendor/miaoxing/plugin/tests/phpmd.xml --exclude vendor --ignore-violations-on-exit
  after-steps:
    - script:
        name: merge error reports
        code: |
          count=`ls -1 build/reports/*.txt 2>/dev/null | wc -l`
          if [ $count != 0 ]; then
            cat build/reports/*.txt > error.txt
          fi
    - miaoxing/github-issue-notify:
        token: $GITHUB_ISSUE_TOKEN
        repo: $GITHUB_ISSUE_REPO
        title: "【$(date +%y-%m-%d)】Build failed: %title%"
        error_file: error.txt
